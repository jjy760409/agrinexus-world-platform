
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AgriNexus Netlify + Logs + 이미지 진단</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
  <style>
    body { font-family: Arial; background: #f5fafd; padding: 2rem; text-align: center; }
    input, button { padding: 0.8rem; font-size: 1rem; margin: 0.5rem; width: 90%; max-width: 500px; border-radius: 6px; border: 1px solid #ccc; }
    canvas, img { margin-top: 1rem; max-width: 100%; border-radius: 8px; }
    .log { color: #007c4d; margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>

  <h1>🚀 AgriNexus Netlify 플랫폼 + 보고서 로그 + 이미지 AI 진단</h1>

  <div>
    <h3>📄 보고서 다운로드 로그 분석</h3>
    <button onclick="logDownload()">📥 보고서 다운로드</button>
    <div class="log" id="logResult"></div>
  </div>

  <div>
    <h3>🌿 작물 이미지 업로드 기반 진단</h3>
    <input type="file" id="imageUpload" accept="image/*" />
    <img id="preview" style="display:none;" />
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <button onclick="detectImage()">🔎 AI 작물 이미지 진단</button>
    <div class="log" id="aiResult"></div>
  </div>

  <script>
    function logDownload() {
      const time = new Date().toLocaleString();
      localStorage.setItem("lastDownload", time);
      document.getElementById("logResult").innerText = "📌 최근 보고서 다운로드 시각: " + time;
    }

    let model;

    async function detectImage() {
      const file = document.getElementById("imageUpload").files[0];
      const img = document.getElementById("preview");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      if (!file) return alert("이미지를 업로드해주세요.");

      const reader = new FileReader();
      reader.onload = async () => {
        img.src = reader.result;
        img.onload = async () => {
          canvas.style.display = "block";
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          if (!model) model = await cocoSsd.load();
          const predictions = await model.detect(canvas);
          predictions.forEach(pred => {
            ctx.strokeStyle = "#007c4d";
            ctx.lineWidth = 2;
            ctx.strokeRect(...pred.bbox);
            ctx.fillStyle = "#007c4d";
            ctx.fillText(pred.class + " " + Math.round(pred.score * 100) + "%", pred.bbox[0], pred.bbox[1] - 5);
          });
          document.getElementById("aiResult").innerText = `예측된 항목 수: ${predictions.length}`;
        };
      };
      reader.readAsDataURL(file);
      img.style.display = "block";
    }
  </script>

</body>
</html>
